# LOG — 2025-09-17

**Período:** 2025-09-17 (America/Sao_Paulo)  
**Escopo:** Correções do calendário/edição; presença de alunos; UX de login/registro; rotas e controller; melhorias de mensagens e scripts.

---

## 1. Calendário & Edição
### calendar.php (refeito)
- Corrigido mês inicial para respeitar `mes=YYYY-MM` e, na ausência, usar o **mês atual**.
- Navegação prev/next com links usando `?mes=YYYY-MM`, sem “pular” indevidamente e mantendo o foco no calendário.
- Cabeçalho do mês com `IntlDateFormatter` (locale `pt_BR`) e timezone `America/Sao_Paulo`.
- Regras de cor de disponibilidade:
  - `bg-success`: livre (nenhum período ocupado)
  - `bg-warning text-dark`: meio período ocupado (P1 XOR P2)
  - `bg-danger`: indisponível (P1 e P2 ocupados)
- Slots:
  - **P1** → 19:15
  - **P2** → 21:10
  - Cada botão possui `data-date` e `data-periodo` e respeita estado `disabled` quando ocupado.
- Uso de classes CSS (`.slot.selected`) para sinalizar a seleção atual e preencher inputs ocultos (`data_evento`, `periodo`).

### edit.php (ajustes)
- `include` do calendário com mês derivado do evento:  
  `$_GET['mes'] ?? substr($event['data_evento'], 0, 7)`
- Mantidos os campos ocultos `data_evento` e `periodo` para refletir a seleção do calendário.
- Distinção de perfil: Coordenação vs. Usuário final.

---

## 2. Página “Meus Eventos” (index)
- Separação entre **Próximos** e **Passados** baseada em `date('Y-m-d')`.
- **Pré-carregamento de presenças** (consultas em lote):
  - Mapa de presenças do usuário logado por `evento_id` (para saber se já confirmou).
  - Mapa de **contagem total** de presenças por evento.
- Cartões exibem:
  - Data formatada corretamente (timezone São Paulo, evitando “um dia antes”).  
  - Faixa horária por período (P1/P2).  
  - Contagem: `X presenças confirmadas`.
- Ações (layout consistente, lado a lado):
  - **ALUNO**: “Marcar Presença” ↔ “Cancelar Presença” (toggle conforme já confirmou ou não).
  - “Ver”, “Editar”, “Excluir”, “Analisar” condicionados a tipo/posse.
- IDs nos cards (`id="evt-<id>"`) para permitir redirect com âncora após post.

---

## 3. Presença (DB + Rotas + Controller)
### Tabela
- **Migration** `2025_09_18_create_presence.sql` (padrão InnoDB, chaves estrangeiras, CASCADE).
- Tabela `presence` com colunas:
  - `id` (PK auto increment)
  - `evento_id` (FK → `events.id`)
  - `usuario_id` (FK → `users.id`)
  - `created_at` (timestamp default CURRENT_TIMESTAMP)
  - `UNIQUE (evento_id, usuario_id)` para evitar duplicidade
- Observação: Nome final escolhido da tabela: `presence`.

### Rotas (pt-BR)
- `POST /eventos/presenca` → `EventController@presence` (callable/array, sem strings tipo “Controller@metodo”)
- `POST /eventos/presenca/remover` → `EventController@removePresence`

### Controller (EventController)
- `presence()`:
  - Validação de método HTTP e sessão.
  - `INSERT ... ON DUPLICATE KEY UPDATE created_at = NOW()` para idempotência.
  - Flash de sucesso e redirect `Location: /eventos#evt-<id>`.
- `removePresence()`:
  - `DELETE FROM presence WHERE evento_id=? AND usuario_id=?`.
  - Flash de aviso/sucesso e redirect com âncora.
- Regras de acesso: somente **ALUNO** marca/desmarca presença (se aplicável).

---

## 4. Login (UX + Robustez)
### View `login.php`
- Inputs com ícones **Lucide** (mail/lock) no mesmo ecossistema visual.
- **Olho de senha**: dois ícones (eye-off/eye) pré-renderizados; o JS apenas alterna `d-none` — sem re-render de SVG.
- Mensagem de erro **amigável** usando `$_SESSION['login_error']` (`alert alert-danger`), sem quebrar a página.

### Controller `login()`
- `session_start()` no início.
- `trim()` no e-mail, check de campos vazios.
- `try/catch` envolvendo acesso ao banco; `error_log()` de exceções.
- Sucesso → redirect `/`; erro → guarda `$_SESSION['login_error']` e redirect `/login`.

### Script unificado `auth.js`
- Toggle do olho (login/register) compatível com markup antigo e novo.
- Aviso de Caps Lock (opcional).
- Validação de confirmação de senha (se `#senha_confirm` existir).

---

## 5. Registro (Register)
- Inputs com ícones Lucide: user, mail, phone, users, book-open, lock.
- Campo **Curso** (obrigatório) com lista **ordenada alfabeticamente** e **sem duplicatas**:
  - Agronomia  
  - Biomedicina  
  - Ciências Biológicas  
  - Ciências Contábeis  
  - Design de Interiores  
  - Direito  
  - Educação Física  
  - Enfermagem  
  - Engenharia Civil  
  - Engenharia de Produção  
  - Engenharia de Software  
  - Engenharia Elétrica  
  - Engenharia Mecânica  
  - Farmácia  
  - Fisioterapia  
  - Medicina Veterinária  
  - Nutrição  
  - Odontologia  
  - Psicologia
- Toggle de senha idêntico ao login (mesma UX e classes).

---

## 6. Mensageria/Flash (layout)
- Bloco genérico de flash:
```php
<?php if (!empty($_SESSION['flash'])): ?>
  <div class="alert alert-<?= $_SESSION['flash']['type'] ?> mt-2 text-center">
    <?= htmlspecialchars($_SESSION['flash']['msg']) ?>
  </div>
  <?php unset($_SESSION['flash']); ?>
<?php endif; ?>
```
- `login_error` tratado diretamente no `login.php` (alerta localizado).

---

## 7. Segurança & UX
- Alternância de ícones via `d-none` (dois ícones estáticos) → evita re-render de SVG e mantém consistência visual.
- Botões de ação usam `type="button"` onde necessário (evita submit acidental).
- Confirmação JavaScript antes de “Cancelar Presença”.
- Uso de timezone correto (`America/Sao_Paulo`) nas formatações de data.

---

## 8. Commits sugeridos
1. `feat(calendar): corrigir mês inicial e navegação com mes=YYYY-MM`
2. `feat(events/edit): carregar calendário no mês do evento`
3. `feat(presence): criar tabela presence e FKs + unique`
4. `feat(routes/controller): adicionar presence() e removePresence()`
5. `feat(my-events): pré-carregar presenças e contagem + botões aluno`
6. `feat(login): ícones, olho de senha, flash amigável`
7. `feat(register): campo curso (ordem A-Z), ícones, toggle de senha`
8. `chore(auth.js): unificar scripts de login/register; capslock + confirm`

---

## 9. Próximos passos (opcional)
- Modelagem de **cursos** como tabela própria (`cursos`) + `users.curso_id` (se for expandir atributos por curso).
- Exportação de presenças por evento (CSV/Excel) para coordenação.
- Exibir lista de alunos presentes no modal “Ver evento”.
- Rate limit básico de login e pequenos logs de auditoria.

